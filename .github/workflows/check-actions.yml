name: Check GitHub Actions Versions

on:
  schedule:
    # æ¯æœˆæ£€æŸ¥ä¸€æ¬¡ Actions ç‰ˆæœ¬
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  check-versions:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for deprecated actions
      run: |
        echo "ðŸ” æ£€æŸ¥ GitHub Actions ç‰ˆæœ¬..."
        
        # æ£€æŸ¥æ‰€æœ‰å·¥ä½œæµæ–‡ä»¶
        find .github/workflows -name "*.yml" -o -name "*.yaml" | while read file; do
          echo "æ£€æŸ¥æ–‡ä»¶: $file"
          
          # æ£€æŸ¥å·²çŸ¥çš„å¼ƒç”¨ç‰ˆæœ¬
          if grep -q "actions/upload-artifact@v[123]" "$file"; then
            echo "âš ï¸  å‘çŽ°å¼ƒç”¨çš„ upload-artifact ç‰ˆæœ¬åœ¨ $file"
          fi
          
          if grep -q "actions/upload-release-asset@v1" "$file"; then
            echo "âš ï¸  å‘çŽ°å¼ƒç”¨çš„ upload-release-asset ç‰ˆæœ¬åœ¨ $file"
          fi
          
          if grep -q "github/codeql-action/upload-sarif@v[12]" "$file"; then
            echo "âš ï¸  å‘çŽ°è¿‡æ—¶çš„ codeql-action ç‰ˆæœ¬åœ¨ $file"
          fi
          
          if grep -q "actions/setup-node@v[123]" "$file"; then
            echo "â„¹ï¸  å»ºè®®æ›´æ–° setup-node åˆ° v4 åœ¨ $file"
          fi
          
          if grep -q "actions/checkout@v[123]" "$file"; then
            echo "â„¹ï¸  å»ºè®®æ›´æ–° checkout åˆ° v4 åœ¨ $file"
          fi
        done
        
        echo "âœ… ç‰ˆæœ¬æ£€æŸ¥å®Œæˆ"

    - name: Create issue if deprecated actions found
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = 'ðŸ”§ å‘çŽ°å¼ƒç”¨çš„ GitHub Actions ç‰ˆæœ¬';
          const body = `
          ## æ£€æµ‹åˆ°å¼ƒç”¨çš„ GitHub Actions ç‰ˆæœ¬
          
          åœ¨å®šæœŸæ£€æŸ¥ä¸­å‘çŽ°äº†ä¸€äº›å¼ƒç”¨çš„ GitHub Actions ç‰ˆæœ¬ã€‚è¯·æ›´æ–°ä»¥ä¸‹ç‰ˆæœ¬ï¼š
          
          ### éœ€è¦æ›´æ–°çš„ Actions:
          
          - \`actions/upload-artifact@v3\` â†’ \`actions/upload-artifact@v4\`
          - \`actions/upload-release-asset@v1\` â†’ \`softprops/action-gh-release@v1\`
          - \`github/codeql-action/upload-sarif@v2\` â†’ \`github/codeql-action/upload-sarif@v3\`
          
          ### å»ºè®®æ›´æ–°çš„ Actions:
          
          - \`actions/setup-node@v3\` â†’ \`actions/setup-node@v4\`
          - \`actions/checkout@v3\` â†’ \`actions/checkout@v4\`
          
          è¯·åŠæ—¶æ›´æ–°è¿™äº›ç‰ˆæœ¬ä»¥é¿å…æž„å»ºå¤±è´¥ã€‚
          `;
          
          // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„ issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['maintenance', 'github-actions']
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes('å¼ƒç”¨çš„ GitHub Actions ç‰ˆæœ¬')
          );
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['maintenance', 'github-actions', 'priority-medium']
            });
          }
