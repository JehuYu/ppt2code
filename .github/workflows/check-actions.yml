name: Check GitHub Actions Versions

on:
  schedule:
    # 每月检查一次 Actions 版本
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  check-versions:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check for deprecated actions
      run: |
        echo "🔍 检查 GitHub Actions 版本..."
        
        # 检查所有工作流文件
        find .github/workflows -name "*.yml" -o -name "*.yaml" | while read file; do
          echo "检查文件: $file"
          
          # 检查已知的弃用版本
          if grep -q "actions/upload-artifact@v[123]" "$file"; then
            echo "⚠️  发现弃用的 upload-artifact 版本在 $file"
          fi
          
          if grep -q "actions/upload-release-asset@v1" "$file"; then
            echo "⚠️  发现弃用的 upload-release-asset 版本在 $file"
          fi
          
          if grep -q "github/codeql-action/upload-sarif@v[12]" "$file"; then
            echo "⚠️  发现过时的 codeql-action 版本在 $file"
          fi
          
          if grep -q "actions/setup-node@v[123]" "$file"; then
            echo "ℹ️  建议更新 setup-node 到 v4 在 $file"
          fi
          
          if grep -q "actions/checkout@v[123]" "$file"; then
            echo "ℹ️  建议更新 checkout 到 v4 在 $file"
          fi
        done
        
        echo "✅ 版本检查完成"

    - name: Create issue if deprecated actions found
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const title = '🔧 发现弃用的 GitHub Actions 版本';
          const body = `
          ## 检测到弃用的 GitHub Actions 版本
          
          在定期检查中发现了一些弃用的 GitHub Actions 版本。请更新以下版本：
          
          ### 需要更新的 Actions:
          
          - \`actions/upload-artifact@v3\` → \`actions/upload-artifact@v4\`
          - \`actions/upload-release-asset@v1\` → \`softprops/action-gh-release@v1\`
          - \`github/codeql-action/upload-sarif@v2\` → \`github/codeql-action/upload-sarif@v3\`
          
          ### 建议更新的 Actions:
          
          - \`actions/setup-node@v3\` → \`actions/setup-node@v4\`
          - \`actions/checkout@v3\` → \`actions/checkout@v4\`
          
          请及时更新这些版本以避免构建失败。
          `;
          
          // 检查是否已存在相同的 issue
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: ['maintenance', 'github-actions']
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes('弃用的 GitHub Actions 版本')
          );
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['maintenance', 'github-actions', 'priority-medium']
            });
          }
